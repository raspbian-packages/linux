From: Sasha Levin <sasha.levin@oracle.com>
Date: Thu, 4 Oct 2012 19:57:31 -0400
Subject: fs: handle failed audit_log_start properly

commit d1c7d97ad58836affde6e39980b96527510b572e upstream.

audit_log_start() may return NULL, this is unchecked by the caller in
audit_log_link_denied() and could cause a NULL ptr deref.

Introduced by commit a51d9eaa ("fs: add link restriction audit reporting").

Signed-off-by: Sasha Levin <sasha.levin@oracle.com>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
---
 kernel/audit.c |    2 ++
 1 file changed, 2 insertions(+)

Index: linux-3.2.46/kernel/audit.c
===================================================================
--- linux-3.2.46.orig/kernel/audit.c	2013-07-26 19:17:53.000000000 +0000
+++ linux-3.2.46/kernel/audit.c	2013-07-26 19:17:54.000000000 +0000
@@ -1459,6 +1459,8 @@
 
 	ab = audit_log_start(current->audit_context, GFP_KERNEL,
 			     AUDIT_ANOM_LINK);
+	if (!ab)
+		return;
 	audit_log_format(ab, "op=%s action=denied", operation);
 	audit_log_format(ab, " pid=%d comm=", current->pid);
 	audit_log_untrustedstring(ab, current->comm);
