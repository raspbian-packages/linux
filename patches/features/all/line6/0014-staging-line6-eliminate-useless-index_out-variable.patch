From: Stefan Hajnoczi <stefanha@gmail.com>
Date: Sat, 10 Dec 2011 02:12:29 +0100
Subject: [014/106] staging: line6: eliminate useless index_out variable

commit 153e38761d27f29edf436f11da3dbfb4fb8edcc1 upstream.

Playback urbs use the index_out counter to decide which part of the
playback buffer to use.  Since the urb already has a unique index in
range [0, LINE6_ISO_BUFFERS) there is no need to keep a separate
counter.

Use the urb index instead.  This also eliminates the possibility of two
urbs using the same playback buffer space if they ever complete
out-of-order for some reason.

Signed-off-by: Stefan Hajnoczi <stefanha@gmail.com>
Signed-off-by: Markus Grabner <grabner@icg.tugraz.at>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
---
 drivers/staging/line6/pcm.h      |    5 -----
 drivers/staging/line6/playback.c |    5 +----
 2 files changed, 1 insertion(+), 9 deletions(-)

Index: linux-3.2.46/drivers/staging/line6/pcm.h
===================================================================
--- linux-3.2.46.orig/drivers/staging/line6/pcm.h	2013-07-26 19:28:10.000000000 +0000
+++ linux-3.2.46/drivers/staging/line6/pcm.h	2013-07-26 19:28:15.000000000 +0000
@@ -146,11 +146,6 @@
 	unsigned char *buffer_in;
 
 	/**
-		 Temporary buffer index for playback.
-	*/
-	int index_out;
-
-	/**
 		 Previously captured frame (for software monitoring).
 	*/
 	unsigned char *prev_fbuf;
Index: linux-3.2.46/drivers/staging/line6/playback.c
===================================================================
--- linux-3.2.46.orig/drivers/staging/line6/playback.c	2013-07-26 19:28:14.000000000 +0000
+++ linux-3.2.46/drivers/staging/line6/playback.c	2013-07-26 19:28:15.000000000 +0000
@@ -192,13 +192,10 @@
 	urb_frames = urb_size / bytes_per_frame;
 	urb_out->transfer_buffer =
 	    line6pcm->buffer_out +
-	    LINE6_ISO_PACKETS * line6pcm->max_packet_size * line6pcm->index_out;
+	    index * LINE6_ISO_PACKETS * line6pcm->max_packet_size;
 	urb_out->transfer_buffer_length = urb_size;
 	urb_out->context = line6pcm;
 
-	if (++line6pcm->index_out == LINE6_ISO_BUFFERS)
-		line6pcm->index_out = 0;
-
 	if (test_bit(BIT_PCM_ALSA_PLAYBACK, &line6pcm->flags) &&
 	    !test_bit(BIT_PAUSE_PLAYBACK, &line6pcm->flags)) {
 		struct snd_pcm_runtime *runtime =
