commit d52d21b77c3e120afde1c7c298307ce176e21a94
Author: popcornmix <popcornmix@gmail.com>
Date:   Sun Aug 19 20:56:11 2012 +0100

    Fix for broken GPIO with 3.2 kernel

Index: linux-3.2.46/arch/arm/mach-bcm2708/bcm2708_gpio.c
===================================================================
--- linux-3.2.46.orig/arch/arm/mach-bcm2708/bcm2708_gpio.c	2013-07-26 19:33:45.000000000 +0000
+++ linux-3.2.46/arch/arm/mach-bcm2708/bcm2708_gpio.c	2013-07-26 19:35:33.000000000 +0000
@@ -70,7 +70,7 @@
 	unsigned gpio_field_offset = (offset - 10 * gpio_bank) * 3;
 
 //printk(KERN_ERR DRIVER_NAME ": bcm2708_gpio_set_function %p (%d,%d)\n", gc, offset, function);
-	if (offset >= ARCH_NR_GPIOS)
+	if (offset >= BCM_NR_GPIOS)
 		return -EINVAL;
 
 	spin_lock_irqsave(&lock, flags);
@@ -108,7 +108,7 @@
 	unsigned gpio_field_offset = (offset - 32 * gpio_bank);
 	unsigned lev;
 
-	if (offset >= ARCH_NR_GPIOS)
+	if (offset >= BCM_NR_GPIOS)
 		return 0;
 	lev = readl(gpio->base + GPIOLEV(gpio_bank));
 //printk(KERN_ERR DRIVER_NAME ": bcm2708_gpio_get %p (%d)=%d\n", gc, offset, 0x1 & (lev>>gpio_field_offset));
@@ -121,7 +121,7 @@
 	unsigned gpio_bank = offset / 32;
 	unsigned gpio_field_offset = (offset - 32 * gpio_bank);
 //printk(KERN_ERR DRIVER_NAME ": bcm2708_gpio_set %p (%d=%d)\n", gc, offset, value);
-	if (offset >= ARCH_NR_GPIOS)
+	if (offset >= BCM_NR_GPIOS)
 		return;
 	if (value)
 		writel(1 << gpio_field_offset, gpio->base + GPIOSET(gpio_bank));
@@ -280,7 +280,7 @@
 
 	ucb->gc.label = "bcm2708_gpio";
 	ucb->gc.base = 0;
-	ucb->gc.ngpio = ARCH_NR_GPIOS;
+	ucb->gc.ngpio = BCM_NR_GPIOS;
 	ucb->gc.owner = THIS_MODULE;
 
 	ucb->gc.direction_input = bcm2708_gpio_dir_in;
Index: linux-3.2.46/arch/arm/mach-bcm2708/include/mach/gpio.h
===================================================================
--- linux-3.2.46.orig/arch/arm/mach-bcm2708/include/mach/gpio.h	2013-07-26 19:33:45.000000000 +0000
+++ linux-3.2.46/arch/arm/mach-bcm2708/include/mach/gpio.h	2013-07-26 19:35:33.000000000 +0000
@@ -9,7 +9,7 @@
 #ifndef __ASM_ARCH_GPIO_H
 #define __ASM_ARCH_GPIO_H
 
-#define ARCH_NR_GPIOS 54 // number of gpio lines
+#define BCM_NR_GPIOS 54 // number of gpio lines
 
 #include <asm-generic/gpio.h>
 #include <mach/platform.h>
@@ -40,6 +40,9 @@
 static inline unsigned gpio_to_irq(unsigned gpio) {
 	return GPIO_IRQ_START+gpio;
 }
+#define gpio_to_irq gpio_to_irq
+
 #endif /* CONFIG_GPIOLIB */
 
 #endif
+
